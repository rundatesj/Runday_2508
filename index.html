<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>August Run - 팀 마일리지 대결</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- 스타일 부분은 그대로 유지 -->
    <style>
        /* ... 기존 CSS 코드 그대로 ... */
    </style>
</head>
<body>
    <!-- HTML 본문 부분 (팀 카드, 입력 폼, 차트, 히스토리) 그대로 유지 -->

    <!-- Google Sheets API 연동 스크립트 -->
    <script>
        const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxGia7tHLCxHqmuJYV_P_t8V6O6umdN3wAOCXrN_Taw6HV2AGRwukGwx5XrwE7_vjwK/exec";

        const crewMembers = {
            "goinggoing": "우유",
            "JS Jeon": "우유",
            "NJ_Run": "우유",
            "거북아달려": "우유",
            "검단이봉주": "우유",
            "겨자색슈즈": "우유",
            "돌아온빵꾸": "우유",
            "마커스": "우유",
            "먕먐": "우유",
            "물냉명": "우유",
            "봉무동러너": "우유",
            "삼남매맘": "우유",
            "상우쌍우": "우유",
            "신욱재": "우유",
            "우유키": "우유",
            "후니": "우유",
            "권초게": "포도",
            "라꾸라꾸조깅": "포도",
            "마이세트": "포도",
            "뭉공주": "포도",
            "바다": "포도",
            "삐약비약": "포도",
            "세동이": "포도",
            "수다맘": "포도",
            "술우": "포도",
            "얼쑤야": "포도",
            "윤호근": "포도",
            "이응내": "포도",
            "자달매": "포도",
            "정영준": "포도",
            "하늘은평": "포도",
            "하하하양": "포도",
            "해피러너": "포도",
            "후다닭": "포도"
        };

        let records = [];
        let teamChart = null;
        let dailyChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            updateMemberSelect();
            loadAndRender();
        });

        function updateMemberSelect() {
            const memberSelect = document.getElementById('memberSelect');
            memberSelect.innerHTML = '<option value="">크루원을 선택하세요</option>';
            const milkMembers = Object.keys(crewMembers).filter(m => crewMembers[m] === '우유');
            const grapeMembers = Object.keys(crewMembers).filter(m => crewMembers[m] === '포도');

            const milkGroup = document.createElement('optgroup');
            milkGroup.label = '🥛 우유팀';
            milkMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                milkGroup.appendChild(option);
            });
            memberSelect.appendChild(milkGroup);

            const grapeGroup = document.createElement('optgroup');
            grapeGroup.label = '🍇 포도팀';
            grapeMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                grapeGroup.appendChild(option);
            });
            memberSelect.appendChild(grapeGroup);
        }

        document.getElementById('memberSelect').addEventListener('change', function() {
            const selected = this.value;
            const team = crewMembers[selected];
            const teamDisplay = document.getElementById('teamDisplay');
            if (team === '우유') {
                teamDisplay.textContent = '🥛 우유팀';
                teamDisplay.style.color = '#FF6B35';
            } else if (team === '포도') {
                teamDisplay.textContent = '🍇 포도팀';
                teamDisplay.style.color = '#4ECDC4';
            } else {
                teamDisplay.textContent = '팀 정보 없음';
                teamDisplay.style.color = '#999';
            }
        });

        document.getElementById('recordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const selectedMember = document.getElementById('memberSelect').value;
            const distance = parseFloat(document.getElementById('distance').value);

            if (!selectedMember || !distance || distance <= 0) {
                alert('입력값을 확인하세요.');
                return;
            }

            const team = crewMembers[selectedMember];
            const now = new Date();

            const record = {
                id: Date.now(),
                team: team,
                name: selectedMember,
                distance: distance,
                date: now.toLocaleDateString('ko-KR'),
                time: now.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})
            };

            await fetch(SHEET_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(record)
            });

            alert('기록이 추가되었습니다!');
            this.reset();
            document.getElementById('teamDisplay').textContent = '팀 정보 없음';
            loadAndRender();
        });

        async function loadAndRender() {
            const res = await fetch(SHEET_API_URL);
            records = await res.json();
            updateDisplay();
        }

        function updateDisplay() {
            // 팀별 총합, 차트, 히스토리 업데이트 그대로 호출
            updateTeamTotals();
            updateMemberLists();
            updateCharts();
            updateHistory();
        }

        async function deleteRecord(id) {
            await fetch(`${SHEET_API_URL}?id=${id}`, { method: 'DELETE' });
            loadAndRender();
        }

        // 기존 updateTeamTotals, updateMemberLists, updateCharts, updateHistory 함수는 그대로 유지

        function bindDeleteButtons() {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    if (confirm('정말 삭제하시겠습니까?')) {
                        deleteRecord(id);
                    }
                });
            });
        }

        // updateHistory 함수 내 delete 버튼 이벤트 등록할 때 bindDeleteButtons() 호출

    </script>
</body>
</html>
